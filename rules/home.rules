// Imports
import org.openhab.core.library.types.*
import org.openhab.core.persistence.*
import org.openhab.model.script.actions.*

// Global Variables
var int onDuration = 5
var Timer _timerBedroom = null

//LUX values definition	
//https://msdn.microsoft.com/en-us/library/windows/desktop/dd319008(v=vs.85).aspx

rule "Bedroom Lamp Controller"
when
    Item iMotionBedroom changed
then
	//RULE: Switch on lamp temporarily if it is dark and motion is detected
	if(iMotionBedroom.state == ON) {
	
		sendCommand(iMotionBedroom, OFF)  
		
		if(iLuxBedroom.state < 400) {
			if(iLampBedroom.state == OFF) {
				sendCommand(iLampBedroom, ON)
			}
	    
	    	if(_timerBedroom != null) {
	    		_timerBedroom.cancel()
	    		_timerBedroom = null
	    	}
	    	
			_timerBedroom = createTimer(now.plusSeconds(onDuration)) [|
			sendCommand(iLampBedroom, OFF)
	  		]
	  	}
  	}
end

rule "Motion Detected"
when
	Item iMotionBedroom changed
	or
	Item iMotionBathroom changed
	or 
	Item iMotionLivingroom changed
then
	//RULE: Alert when Motion is detected and there is no one at home
	if(((iMotionBedroom.state == ON) || (iMotionBathroom.state == ON) || (iMotionLivingroom.state == ON)) && (iPresenceSumit.state == OFF)) {
		sendTelegram("SwedesiBot" , "Motion Detected")
		sendTelegramPhoto("SwedesiBot", "https://unsplash.it/300/200/?random", null)	
	}
end	